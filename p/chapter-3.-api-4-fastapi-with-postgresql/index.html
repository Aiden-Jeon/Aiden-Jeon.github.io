<!doctype html><html lang=en-us dir=ltr><head><meta charset=utf-8><meta name=viewport content='width=device-width,initial-scale=1'><meta name=description content="Github 에서 해당 내용에 대해서 확인할 수 있습니다.\nOverview 목표 앞서 작성한 fastapi의 정보를 postgesql db에 작성합니다. 요구사항 Postgresql 서버를 실행합니다. 데이터가 저장되고 있는 도커와는 다른 서버를 실행해주세요. 포트가 사용중이라면 5433 으로 포워딩합니다. 다음 과정에 따라 create 함수로 입력 받는 값을 postgresql 에 저장하게 합니다. ORM(Object Relational Mapping) 에 대해서 알아봅니다. [ORMs] database.py 파일을 생성합니다.[File Structure] 튜토리얼을 따라 postgresql 과 연결할 수 있는 session_maker를 작성합니다. [Create the SQLAlchemy parts] models.py 파일을 생성합니다. tablename은 users로 합니다. 튜토리얼을 따라 postgresql 에서 사용하는 모델을 생성합니다. [Create the database model] Column Type Key id Integer Primary, Index name String Unique, Index nickname String schemas.py 파일을 생성합니다. [create-pydantic-models-schemas-for-reading-returning] crud.py 파일을 생성 후 아래 함수를 작성합니다. [Crud Utils] get_user creat_user 구현 database [Create the SQLAlchemy parts]을 따라서 database.py 파일을 작성합니다.\n"><title>[ Chapter 3. API ] 4) FastAPI with Postgresql</title>
<link rel=canonical href=https://aiden-jeon.github.io/blog/p/chapter-3.-api-4-fastapi-with-postgresql/><link rel=stylesheet href=/blog/scss/style.min.663803bebe609202d5b39d848f2d7c2dc8b598a2d879efa079fa88893d29c49c.css><meta property='og:title' content="[ Chapter 3. API ] 4) FastAPI with Postgresql"><meta property='og:description' content="Github 에서 해당 내용에 대해서 확인할 수 있습니다.\nOverview 목표 앞서 작성한 fastapi의 정보를 postgesql db에 작성합니다. 요구사항 Postgresql 서버를 실행합니다. 데이터가 저장되고 있는 도커와는 다른 서버를 실행해주세요. 포트가 사용중이라면 5433 으로 포워딩합니다. 다음 과정에 따라 create 함수로 입력 받는 값을 postgresql 에 저장하게 합니다. ORM(Object Relational Mapping) 에 대해서 알아봅니다. [ORMs] database.py 파일을 생성합니다.[File Structure] 튜토리얼을 따라 postgresql 과 연결할 수 있는 session_maker를 작성합니다. [Create the SQLAlchemy parts] models.py 파일을 생성합니다. tablename은 users로 합니다. 튜토리얼을 따라 postgresql 에서 사용하는 모델을 생성합니다. [Create the database model] Column Type Key id Integer Primary, Index name String Unique, Index nickname String schemas.py 파일을 생성합니다. [create-pydantic-models-schemas-for-reading-returning] crud.py 파일을 생성 후 아래 함수를 작성합니다. [Crud Utils] get_user creat_user 구현 database [Create the SQLAlchemy parts]을 따라서 database.py 파일을 작성합니다.\n"><meta property='og:url' content='https://aiden-jeon.github.io/blog/p/chapter-3.-api-4-fastapi-with-postgresql/'><meta property='og:site_name' content="Aiden's Camp"><meta property='og:type' content='article'><meta property='article:section' content='Post'><meta property='article:tag' content='model-registry'><meta property='article:tag' content='api'><meta property='article:tag' content='fastapi'><meta property='article:tag' content='postgresql'><meta property='article:published_time' content='2022-09-23T20:40:00+09:00'><meta property='article:modified_time' content='2022-09-23T20:40:00+09:00'><meta name=twitter:title content="[ Chapter 3. API ] 4) FastAPI with Postgresql"><meta name=twitter:description content="Github 에서 해당 내용에 대해서 확인할 수 있습니다.\nOverview 목표 앞서 작성한 fastapi의 정보를 postgesql db에 작성합니다. 요구사항 Postgresql 서버를 실행합니다. 데이터가 저장되고 있는 도커와는 다른 서버를 실행해주세요. 포트가 사용중이라면 5433 으로 포워딩합니다. 다음 과정에 따라 create 함수로 입력 받는 값을 postgresql 에 저장하게 합니다. ORM(Object Relational Mapping) 에 대해서 알아봅니다. [ORMs] database.py 파일을 생성합니다.[File Structure] 튜토리얼을 따라 postgresql 과 연결할 수 있는 session_maker를 작성합니다. [Create the SQLAlchemy parts] models.py 파일을 생성합니다. tablename은 users로 합니다. 튜토리얼을 따라 postgresql 에서 사용하는 모델을 생성합니다. [Create the database model] Column Type Key id Integer Primary, Index name String Unique, Index nickname String schemas.py 파일을 생성합니다. [create-pydantic-models-schemas-for-reading-returning] crud.py 파일을 생성 후 아래 함수를 작성합니다. [Crud Utils] get_user creat_user 구현 database [Create the SQLAlchemy parts]을 따라서 database.py 파일을 작성합니다.\n"><link rel="shortcut icon" href=/blog/icons/favicon.ico><script async src="https://www.googletagmanager.com/gtag/js?id=G-419F58RW9W"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-419F58RW9W")}</script></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label="Toggle Menu">
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/blog/><img src=/blog/imgs/avatar_hu6933059792947527008.png width=300 height=300 class=site-logo loading=lazy alt=Avatar>
</a><span class=emoji>🔥</span></figure><div class=site-meta><h1 class=site-name><a href=/blog>Aiden's Camp</a></h1><h2 class=site-description>Welcome to Aiden's Camp</h2></div></header><ol class=menu-social><li><a href=https://github.com/Aiden-Jeon target=_blank title=GitHub rel=me><svg class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 19c-4.3 1.4-4.3-2.5-6-3m12 5v-3.5c0-1 .1-1.4-.5-2 2.8-.3 5.5-1.4 5.5-6a4.6 4.6.0 00-1.3-3.2 4.2 4.2.0 00-.1-3.2s-1.1-.3-3.5 1.3a12.3 12.3.0 00-6.2.0C6.5 2.8 5.4 3.1 5.4 3.1a4.2 4.2.0 00-.1 3.2A4.6 4.6.0 004 9.5c0 4.6 2.7 5.7 5.5 6-.6.6-.6 1.2-.5 2V21"/></svg></a></li><li><a href=https://www.linkedin.com/in/jongseob-jeon/ target=_blank title=Linkedin rel=me><svg fill="#000" height="800" width="800" id="Layer_1" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 310 310"><g id="XMLID_801_"><path id="XMLID_802_" d="M72.16 99.73H9.927c-2.762.0-5 2.239-5 5v199.928c0 2.762 2.238 5 5 5H72.16c2.762.0 5-2.238 5-5V104.73c0-2.76100000000001-2.238-5-5-5z"/><path id="XMLID_803_" d="M41.066.341C18.422.341.0 18.743.0 41.362.0 63.991 18.422 82.4 41.066 82.4c22.626.0 41.033-18.41 41.033-41.038C82.1 18.743 63.692.341 41.066.341z"/><path id="XMLID_804_" d="M230.454 94.761c-24.995.0-43.472 10.745-54.679 22.954V104.73c0-2.761-2.238-5-5-5h-59.599c-2.762.0-5 2.239-5 5v199.928c0 2.762 2.238 5 5 5h62.097c2.762.0 5-2.238 5-5V205.74c0-33.333 9.054-46.319 32.29-46.319 25.306.0 27.317 20.818 27.317 48.034v97.204c0 2.762 2.238 5 5 5H305c2.762.0 5-2.238 5-5V194.995C310 145.43 300.549 94.761 230.454 94.761z"/></g></svg></a></li></ol><ol class=menu id=main-menu><li><a href=/blog/><svg class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg>
<span>Home</span></a></li><li><a href=/blog/categories><svg class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg>
<span>Categories</span></a></li><li><a href=/blog/tags><svg class="icon icon-tabler icon-tabler-tag" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11 3l9 9a1.5 1.5.0 010 2l-6 6a1.5 1.5.0 01-2 0L3 11V7a4 4 0 014-4h4"/><circle cx="9" cy="9" r="2"/></svg>
<span>Tags</span></a></li><li><a href=/blog/links/><svg class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M10 14a3.5 3.5.0 005 0l4-4a3.5 3.5.0 00-5-5l-.5.5"/><path d="M14 10a3.5 3.5.0 00-5 0l-4 4a3.5 3.5.0 005 5l.5-.5"/></svg>
<span>Links</span></a></li><li><a href=/blog/search/><svg class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg>
<span>Search</span></a></li><li><a href=/blog/archives/><svg class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg>
<span>Archives</span></a></li><li class=menu-bottom-section><ol class=menu><li id=dark-mode-toggle><svg class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<svg class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<span>Dark Mode</span></li></ol></li></ol></aside><aside class="sidebar right-sidebar sticky"><section class="widget archives"><div class=widget-icon><svg class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">Table of contents</h2><div class=widget--toc><nav id=TableOfContents><ul><li><a href=#overview>Overview</a><ul><li><a href=#목표>목표</a></li><li><a href=#요구사항>요구사항</a></li></ul></li><li><a href=#구현>구현</a><ul><li><a href=#database>database</a></li><li><a href=#models>models</a></li><li><a href=#schemas>schemas</a></li><li><a href=#crud>crud</a></li></ul></li><li><a href=#실행>실행</a></li></ul></nav></div></section></aside><main class="main full-width"><article class=main-article><header class=article-header><div class=article-details><header class=article-category><a href=/blog/categories/mle-mlops/>Mle-Mlops</a></header><div class=article-title-wrapper><h2 class=article-title><a href=/blog/p/chapter-3.-api-4-fastapi-with-postgresql/>[ Chapter 3. API ] 4) FastAPI with Postgresql</a></h2></div><footer class=article-time><div><svg class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg>
<time class=article-time--published>Sep 23, 2022</time></div><div><svg class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<time class=article-time--reading>3 minute read</time></div></footer></div></header><section class=article-content><p><a class=link href=https://github.com/Aiden-Jeon/mle-mlops/tree/main/03_api target=_blank rel=noopener>Github</a> 에서 해당 내용에 대해서 확인할 수 있습니다.</p><h2 id=overview><a href=#overview class=header-anchor></a>Overview</h2><h3 id=목표><a href=#%eb%aa%a9%ed%91%9c class=header-anchor></a>목표</h3><ul><li>앞서 작성한 fastapi의 정보를 postgesql db에 작성합니다.</li></ul><h3 id=요구사항><a href=#%ec%9a%94%ea%b5%ac%ec%82%ac%ed%95%ad class=header-anchor></a>요구사항</h3><ol><li>Postgresql 서버를 실행합니다.<ul><li>데이터가 저장되고 있는 도커와는 다른 서버를 실행해주세요.</li><li>포트가 사용중이라면 5433 으로 포워딩합니다.</li></ul></li><li>다음 과정에 따라 create 함수로 입력 받는 값을 postgresql 에 저장하게 합니다.<ol><li>ORM(Object Relational Mapping) 에 대해서 알아봅니다. [<a class=link href="https://fastapi.tiangolo.com/tutorial/sql-databases/?h=pydantic#orms" target=_blank rel=noopener>ORMs</a>]</li><li><code>database.py</code> 파일을 생성합니다.[<a class=link href="https://fastapi.tiangolo.com/tutorial/sql-databases/?h=pydantic#file-structure" target=_blank rel=noopener>File Structure</a>]<ul><li>튜토리얼을 따라 postgresql 과 연결할 수 있는 session_maker를 작성합니다. [<a class=link href="https://fastapi.tiangolo.com/tutorial/sql-databases/?h=pydantic#create-the-sqlalchemy-parts" target=_blank rel=noopener>Create the SQLAlchemy parts</a>]</li></ul></li><li><code>models.py</code> 파일을 생성합니다.<ul><li>tablename은 users로 합니다.</li><li>튜토리얼을 따라 postgresql 에서 사용하는 모델을 생성합니다. [<a class=link href="https://fastapi.tiangolo.com/tutorial/sql-databases/?h=pydantic#create-the-database-models" target=_blank rel=noopener>Create the database model</a>]</li></ul><div class=table-wrapper><table><thead><tr><th style=text-align:left>Column</th><th style=text-align:left>Type</th><th style=text-align:left>Key</th></tr></thead><tbody><tr><td style=text-align:left>id</td><td style=text-align:left>Integer</td><td style=text-align:left>Primary, Index</td></tr><tr><td style=text-align:left>name</td><td style=text-align:left>String</td><td style=text-align:left>Unique, Index</td></tr><tr><td style=text-align:left>nickname</td><td style=text-align:left>String</td><td style=text-align:left></td></tr></tbody></table></div></li><li><code>schemas.py</code> 파일을 생성합니다. [<a class=link href="https://fastapi.tiangolo.com/tutorial/sql-databases/?h=pydantic#create-pydantic-models-schemas-for-reading-returning" target=_blank rel=noopener>create-pydantic-models-schemas-for-reading-returning</a>]</li><li><code>crud.py</code> 파일을 생성 후 아래 함수를 작성합니다. [<a class=link href="https://fastapi.tiangolo.com/tutorial/sql-databases/?h=pydantic#crud-utils" target=_blank rel=noopener>Crud Utils</a>]<ul><li><code>get_user</code></li><li><code>creat_user</code></li></ul></li></ol></li></ol><hr><h2 id=구현><a href=#%ea%b5%ac%ed%98%84 class=header-anchor></a>구현</h2><h3 id=database><a href=#database class=header-anchor></a>database</h3><p>[<a class=link href="https://fastapi.tiangolo.com/tutorial/sql-databases/?h=pydantic#create-the-sqlalchemy-parts" target=_blank rel=noopener>Create the SQLAlchemy parts</a>]을 따라서 <code>database.py</code> 파일을 작성합니다.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># database.py</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>os</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>sqlalchemy</span> <span class=kn>import</span> <span class=n>create_engine</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>sqlalchemy.ext.declarative</span> <span class=kn>import</span> <span class=n>declarative_base</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>sqlalchemy.orm</span> <span class=kn>import</span> <span class=n>sessionmaker</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>SQLALCHEMY_DATABASE_URL</span> <span class=o>=</span> <span class=n>os</span><span class=o>.</span><span class=n>getenv</span><span class=p>(</span><span class=s2>&#34;SQLALCHEMY_DATABASE_URL&#34;</span><span class=p>,</span> <span class=s2>&#34;postgresql://postgres:mypassword@localhost:5432/postgres&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>engine</span> <span class=o>=</span> <span class=n>create_engine</span><span class=p>(</span><span class=n>SQLALCHEMY_DATABASE_URL</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>SessionLocal</span> <span class=o>=</span> <span class=n>sessionmaker</span><span class=p>(</span><span class=n>autocommit</span><span class=o>=</span><span class=kc>False</span><span class=p>,</span> <span class=n>autoflush</span><span class=o>=</span><span class=kc>False</span><span class=p>,</span> <span class=n>bind</span><span class=o>=</span><span class=n>engine</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>Base</span> <span class=o>=</span> <span class=n>declarative_base</span><span class=p>()</span>
</span></span></code></pre></td></tr></table></div></div><p>이 중 <code>SQLALCHEMY_DATABASE_URL</code> 값은 나중에 docker에서 값을 변경해서 전달 할 수 있도록 <code>os.getenv</code>를 통해 가져오도록 합니다.<br>로컬에서 진행하는 튜토리얼에서는 기본 값으로 사용하도록 합니다.</p><h3 id=models><a href=#models class=header-anchor></a>models</h3><p>[<a class=link href="https://fastapi.tiangolo.com/tutorial/sql-databases/?h=pydantic#create-the-database-models" target=_blank rel=noopener>Create the database model</a>]을 따라서 <code>models.py</code> 파일을 작성합니다.</p><p>tablename은 요구사항에 맞춰 <code>users</code>로 정합니다.
나머지 column들도 주어진 요구사항에 맞춰서 작성합니다.</p><div class=table-wrapper><table><thead><tr><th style=text-align:left>Column</th><th style=text-align:left>Type</th><th style=text-align:left>Key</th></tr></thead><tbody><tr><td style=text-align:left>id</td><td style=text-align:left>Integer</td><td style=text-align:left>Primary, Index</td></tr><tr><td style=text-align:left>name</td><td style=text-align:left>String</td><td style=text-align:left>Unique, Index</td></tr><tr><td style=text-align:left>nickname</td><td style=text-align:left>String</td><td style=text-align:left></td></tr></tbody></table></div><ul><li><code>id</code> : <code>Column(Integer, primary_key=True, index=True)</code></li><li><code>name</code>: <code>Column(String, unique=True, index=True)</code></li><li><code>nickname</code>: <code>Column(String)</code></li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># models.py</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>sqlalchemy</span> <span class=kn>import</span> <span class=n>Column</span><span class=p>,</span> <span class=n>Integer</span><span class=p>,</span> <span class=n>String</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>database</span> <span class=kn>import</span> <span class=n>Base</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>User</span><span class=p>(</span><span class=n>Base</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>__tablename__</span> <span class=o>=</span> <span class=s2>&#34;users&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nb>id</span> <span class=o>=</span> <span class=n>Column</span><span class=p>(</span><span class=n>Integer</span><span class=p>,</span> <span class=n>primary_key</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span> <span class=n>index</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>name</span> <span class=o>=</span> <span class=n>Column</span><span class=p>(</span><span class=n>String</span><span class=p>,</span> <span class=n>unique</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span> <span class=n>index</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>nickname</span> <span class=o>=</span> <span class=n>Column</span><span class=p>(</span><span class=n>String</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=schemas><a href=#schemas class=header-anchor></a>schemas</h3><p>[<a class=link href="https://fastapi.tiangolo.com/tutorial/sql-databases/?h=pydantic#create-pydantic-models-schemas-for-reading-returning" target=_blank rel=noopener>create-pydantic-models-schemas-for-reading-returning</a>]을 따라서 <code>schemas.py</code> 파일을 작성합니다.</p><p>이 전 포스트에서 작성한 pydantic model을 활용합니다.<br>우선 <code>UseCreateIn</code>, <code>UserCreateOut</code> 모두에서 사용할 <code>UserBase</code>를 작성합니다.<br><code>UseCreateIn</code>, <code>UserCreateOut</code>는 작성한 <code>UserBase</code> 를 상속받습니다<br><code>UserCreateOut</code> 는 추가로 <code>status</code> 와 <code>id</code>를 입력합니다.<br>마지막으로 database 에서 사용할 <code>User</code> class를 작성합니다. db에서 사용해야 하니 <code>orm_mode</code> 를 <code>True</code> 로 입력합니다.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># schemas.py</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>pydantic</span> <span class=kn>import</span> <span class=n>BaseModel</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>UserBase</span><span class=p>(</span><span class=n>BaseModel</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>name</span><span class=p>:</span> <span class=nb>str</span>
</span></span><span class=line><span class=cl>    <span class=n>nickname</span><span class=p>:</span> <span class=nb>str</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>UserCreateIn</span><span class=p>(</span><span class=n>UserBase</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>pass</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>UserCreateOut</span><span class=p>(</span><span class=n>UserBase</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>status</span><span class=p>:</span> <span class=nb>str</span>
</span></span><span class=line><span class=cl>    <span class=nb>id</span><span class=p>:</span> <span class=nb>int</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>User</span><span class=p>(</span><span class=n>UserBase</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=nb>id</span><span class=p>:</span> <span class=nb>int</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>class</span> <span class=nc>Config</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>orm_mode</span> <span class=o>=</span> <span class=kc>True</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=crud><a href=#crud class=header-anchor></a>crud</h3><p>[<a class=link href="https://fastapi.tiangolo.com/tutorial/sql-databases/?h=pydantic#crud-utils" target=_blank rel=noopener>Crud Utils</a>]을 따라서 <code>crud.py</code> 를 작성합니다.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># crud.py</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>fastapi</span> <span class=kn>import</span> <span class=n>Depends</span><span class=p>,</span> <span class=n>FastAPI</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>sqlalchemy.orm</span> <span class=kn>import</span> <span class=n>Session</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>models</span> <span class=kn>import</span> <span class=n>User</span><span class=p>,</span> <span class=n>Base</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>schemas</span> <span class=kn>import</span> <span class=n>UserCreateIn</span><span class=p>,</span> <span class=n>UserCreateOut</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>database</span> <span class=kn>import</span> <span class=n>SessionLocal</span><span class=p>,</span> <span class=n>engine</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>Base</span><span class=o>.</span><span class=n>metadata</span><span class=o>.</span><span class=n>create_all</span><span class=p>(</span><span class=n>bind</span><span class=o>=</span><span class=n>engine</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>app</span> <span class=o>=</span> <span class=n>FastAPI</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Dependency</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>get_db</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=n>db</span> <span class=o>=</span> <span class=n>SessionLocal</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>yield</span> <span class=n>db</span>
</span></span><span class=line><span class=cl>    <span class=k>finally</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>db</span><span class=o>.</span><span class=n>close</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@app.get</span><span class=p>(</span><span class=s2>&#34;/user&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>get_user</span><span class=p>(</span><span class=n>user_id</span><span class=p>:</span> <span class=nb>int</span><span class=p>,</span> <span class=n>db</span><span class=p>:</span> <span class=n>Session</span> <span class=o>=</span> <span class=n>Depends</span><span class=p>(</span><span class=n>get_db</span><span class=p>)):</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>db</span><span class=o>.</span><span class=n>query</span><span class=p>(</span><span class=n>User</span><span class=p>)</span><span class=o>.</span><span class=n>filter</span><span class=p>(</span><span class=n>User</span><span class=o>.</span><span class=n>id</span> <span class=o>==</span> <span class=n>user_id</span><span class=p>)</span><span class=o>.</span><span class=n>first</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@app.post</span><span class=p>(</span><span class=s2>&#34;/user&#34;</span><span class=p>,</span> <span class=n>response_model</span><span class=o>=</span><span class=n>UserCreateOut</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>create_user</span><span class=p>(</span><span class=n>user</span><span class=p>:</span> <span class=n>UserCreateIn</span><span class=p>,</span> <span class=n>db</span><span class=p>:</span> <span class=n>Session</span> <span class=o>=</span> <span class=n>Depends</span><span class=p>(</span><span class=n>get_db</span><span class=p>)):</span>
</span></span><span class=line><span class=cl>    <span class=n>db_user</span> <span class=o>=</span> <span class=n>User</span><span class=p>(</span><span class=n>name</span><span class=o>=</span><span class=n>user</span><span class=o>.</span><span class=n>name</span><span class=p>,</span> <span class=n>nickname</span><span class=o>=</span><span class=n>user</span><span class=o>.</span><span class=n>nickname</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>db</span><span class=o>.</span><span class=n>add</span><span class=p>(</span><span class=n>db_user</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>db</span><span class=o>.</span><span class=n>commit</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>db</span><span class=o>.</span><span class=n>refresh</span><span class=p>(</span><span class=n>db_user</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>UserCreateOut</span><span class=p>(</span><span class=n>name</span><span class=o>=</span><span class=n>db_user</span><span class=o>.</span><span class=n>name</span><span class=p>,</span> <span class=n>nickname</span><span class=o>=</span><span class=n>db_user</span><span class=o>.</span><span class=n>nickname</span><span class=p>,</span> <span class=n>status</span><span class=o>=</span><span class=s2>&#34;success&#34;</span><span class=p>,</span> <span class=nb>id</span><span class=o>=</span><span class=n>db_user</span><span class=o>.</span><span class=n>id</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=실행><a href=#%ec%8b%a4%ed%96%89 class=header-anchor></a>실행</h2><p>작성한 app을 실행하고 databse에 저장되는지 확인합니다.</p><p>우선 database 가 실행되지 않았다면 실행합니다.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>docker run -p 5432:5432 -e <span class=nv>POSTGRES_PASSWORD</span><span class=o>=</span>mypassword -d postgres
</span></span></code></pre></td></tr></table></div></div><p>다음으로 uvicorn을 이용해 app을 실행합니다.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>uvicorn crud:app --reload
</span></span></code></pre></td></tr></table></div></div><p><code>POST /user</code> 을 통해 유저를 생성합니다.<br>생성 후 <code>psql</code> 로 생성되었는지 확인합니다.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>psql -h localhost -p <span class=m>5432</span> -U postgres postgres
</span></span></code></pre></td></tr></table></div></div><p>정상적으로 추가가 된 것을 확인할 수 있습니다.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>postgres=# SELECT * FROM users;
</span></span><span class=line><span class=cl> id |  name  | nickname
</span></span><span class=line><span class=cl>----+--------+----------
</span></span><span class=line><span class=cl>  1 | string | string
</span></span><span class=line><span class=cl>(1 row)
</span></span></code></pre></td></tr></table></div></div></section><footer class=article-footer><section class=article-tags><a href=/blog/tags/model-registry/>Model-Registry</a>
<a href=/blog/tags/api/>Api</a>
<a href=/blog/tags/fastapi/>Fastapi</a>
<a href=/blog/tags/postgresql/>Postgresql</a></section><section class=article-copyright><svg class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg>
<span>Licensed under CC BY-NC-SA 4.0</span></section></footer><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css integrity=sha384-n8MVd4RsNIU0tAv4ct0nTaAbDJwPJzDEaqSD1odI+WdtXRGWt2kTvGFasHpSy3SV crossorigin=anonymous><script src=https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js integrity=sha384-XjKyOOlGwcjNTAIQHIpgOno0Hl1YQqzUOEleOLALmuqehneUG+vnGctmUb0ZY0l8 crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js integrity=sha384-+VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4+/RRE05 crossorigin=anonymous defer></script><script>window.addEventListener("DOMContentLoaded",()=>{renderMathInElement(document.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1},{left:"\\(",right:"\\)",display:!1},{left:"\\[",right:"\\]",display:!0}],ignoredClasses:["gist"]})})</script></article><aside class=related-content--wrapper><h2 class=section-title>Related content</h2><div class=related-content><div class="flex article-list--tile"><article><a href=/blog/p/chapter-3.-api-5-build-fastapi-docker/><div class=article-details><h2 class=article-title>[ Chapter 3. API ] 5) Build FastAPI Docker</h2></div></a></article><article><a href=/blog/p/chapter-3.-api-3-fastapi-crud-with-pydantic/><div class=article-details><h2 class=article-title>[ Chapter 3. API ] 3) FastAPI CRUD with Pydantic</h2></div></a></article><article class=has-image><a href=/blog/p/chapter-3.-api-2-fastapi-crud/><div class=article-image><img src=/blog/p/chapter-3.-api-2-fastapi-crud/swagger.2291ba83f693ed8c9e5edc961b76db2b_hu8697934523795967584.png width=250 height=150 loading=lazy alt="Featured image of post [ Chapter 3. API ] 2) FastAPI CRUD" data-hash="md5-IpG6g/aT7YyeXtyWG3bbKw=="></div><div class=article-details><h2 class=article-title>[ Chapter 3. API ] 2) FastAPI CRUD</h2></div></a></article><article><a href=/blog/p/chapter-4.-model-api-4-docker-without-model/><div class=article-details><h2 class=article-title>[ Chapter 4. Model API ] 4) Docker without model</h2></div></a></article><article><a href=/blog/p/chapter-4.-model-api-3-docker-with-model/><div class=article-details><h2 class=article-title>[ Chapter 4. Model API ] 3) Docker with model</h2></div></a></article></div></div></aside><script src=https://utteranc.es/client.js repo=aiden-jeon/aiden-jeon.github.io issue-term=pathname label=comment crossorigin=anonymous async></script><style>.utterances{max-width:unset}</style><script>let utterancesLoaded=!1;function setUtterancesTheme(e){let t=document.querySelector(".utterances iframe");t&&t.contentWindow.postMessage({type:"set-theme",theme:`github-${e}`},"https://utteranc.es")}addEventListener("message",e=>{if(e.origin!=="https://utteranc.es")return;utterancesLoaded=!0,setUtterancesTheme(document.documentElement.dataset.scheme)}),window.addEventListener("onColorSchemeChange",e=>{if(!utterancesLoaded)return;setUtterancesTheme(e.detail)})</script><footer class=site-footer><section class=copyright>&copy;
2020 -
2024 Aiden's Camp</section><section class=powerby>Built with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a><br>Theme <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.27.0>Stack</a></b> designed by <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a></section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css crossorigin=anonymous></main></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=/blog/ts/main.js defer></script><script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>